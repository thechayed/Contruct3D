"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[796],{3796:(e,t,n)=>{n.d(t,{Rhino3dmLoader:()=>i});var r=n(9451),o=n(7680);class s extends r.DataTextureLoader{constructor(e){super(e),this.type=r.HalfFloatType}parse(e){const t=65536,n=14,s=65537,a=Math.pow(2.7182818,2.2),i={l:0,c:0,lc:0};function l(e,t,n,r,o){for(;n<e;)t=t<<8|j(r,o),n+=8;n-=e,i.l=t>>n&(1<<e)-1,i.c=t,i.lc=n}const c=new Array(59);function u(e){return 63&e}function p(e){return e>>6}const d={c:0,lc:0};function h(e,t,n,r){e=e<<8|j(n,r),t+=8,d.c=e,d.lc=t}const f={c:0,lc:0};function g(e,t,n,r,o,s,a,i,l){if(e==t){r<8&&(h(n,r,o,s),n=d.c,r=d.lc);let e=n>>(r-=8);if(e=new Uint8Array([e])[0],i.value+e>l)return!1;const t=a[i.value-1];for(;e-- >0;)a[i.value++]=t}else{if(!(i.value<l))return!1;a[i.value++]=e}f.c=n,f.lc=r}function y(e){return 65535&e}function m(e){const t=y(e);return t>32767?t-65536:t}const w={a:0,b:0};function b(e,t){const n=m(e),r=m(t),o=n+(1&r)+(r>>1),s=o,a=o-r;w.a=s,w.b=a}function S(e,t){const n=y(e),r=y(t),o=n-(r>>1)&65535,s=r+o-32768&65535;w.a=s,w.b=o}function v(e,t,n,r,o,s,a){const i=a<16384,l=n>o?o:n;let c,u,p=1;for(;p<=l;)p<<=1;for(p>>=1,c=p,p>>=1;p>=1;){u=0;const a=u+s*(o-c),l=s*p,d=s*c,h=r*p,f=r*c;let g,y,m,v;for(;u<=a;u+=d){let o=u;const s=u+r*(n-c);for(;o<=s;o+=f){const n=o+h,r=o+l,s=r+h;i?(b(e[o+t],e[r+t]),g=w.a,m=w.b,b(e[n+t],e[s+t]),y=w.a,v=w.b,b(g,y),e[o+t]=w.a,e[n+t]=w.b,b(m,v),e[r+t]=w.a,e[s+t]=w.b):(S(e[o+t],e[r+t]),g=w.a,m=w.b,S(e[n+t],e[s+t]),y=w.a,v=w.b,S(g,y),e[o+t]=w.a,e[n+t]=w.b,S(m,v),e[r+t]=w.a,e[s+t]=w.b)}if(n&p){const n=o+l;i?b(e[o+t],e[n+t]):S(e[o+t],e[n+t]),g=w.a,e[n+t]=w.b,e[o+t]=g}}if(o&p){let o=u;const s=u+r*(n-c);for(;o<=s;o+=f){const n=o+h;i?b(e[o+t],e[n+t]):S(e[o+t],e[n+t]),g=w.a,e[n+t]=w.b,e[o+t]=g}}c=p,p>>=1}return u}function C(e,t,r,o,a,y){const m=r.value,w=N(t,r),b=N(t,r);r.value+=4;const S=N(t,r);if(r.value+=4,w<0||w>=s||b<0||b>=s)throw new Error("Something wrong with HUF_ENCSIZE");const v=new Array(s),C=new Array(16384);if(function(e){for(let t=0;t<16384;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(C),function(e,t,n,r,o,a){const u=t;let p=0,d=0;for(;r<=o;r++){if(u.value-t.value>n)return!1;l(6,p,d,e,u);const s=i.l;if(p=i.c,d=i.lc,a[r]=s,63==s){if(u.value-t.value>n)throw new Error("Something wrong with hufUnpackEncTable");l(8,p,d,e,u);let s=i.l+6;if(p=i.c,d=i.lc,r+s>o+1)throw new Error("Something wrong with hufUnpackEncTable");for(;s--;)a[r++]=0;r--}else if(s>=59){let e=s-59+2;if(r+e>o+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)a[r++]=0;r--}}!function(e){for(let e=0;e<=58;++e)c[e]=0;for(let t=0;t<s;++t)c[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const n=t+c[e]>>1;c[e]=t,t=n}for(let t=0;t<s;++t){const n=e[t];n>0&&(e[t]=n|c[n]++<<6)}}(a)}(e,r,o-(r.value-m),w,b,v),S>8*(o-(r.value-m)))throw new Error("Something wrong with hufUncompress");!function(e,t,r,o){for(;t<=r;t++){const r=p(e[t]),s=u(e[t]);if(r>>s)throw new Error("Invalid table entry");if(s>n){const e=o[r>>s-n];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let n=0;n<e.lit-1;++n)e.p[n]=t[n]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(s){let e=0;for(let a=1<<n-s;a>0;a--){const a=o[(r<<n-s)+e];if(a.len||a.p)throw new Error("Invalid table entry");a.len=s,a.lit=t,e++}}}}(v,w,b,C),function(e,t,r,o,s,a,i,l,c){let y=0,m=0;const w=i,b=Math.trunc(o.value+(s+7)/8);for(;o.value<b;)for(h(y,m,r,o),y=d.c,m=d.lc;m>=n;){const s=t[y>>m-n&16383];if(s.len)m-=s.len,g(s.lit,a,y,m,r,o,l,c,w),y=f.c,m=f.lc;else{if(!s.p)throw new Error("hufDecode issues");let t;for(t=0;t<s.lit;t++){const n=u(e[s.p[t]]);for(;m<n&&o.value<b;)h(y,m,r,o),y=d.c,m=d.lc;if(m>=n&&p(e[s.p[t]])==(y>>m-n&(1<<n)-1)){m-=n,g(s.p[t],a,y,m,r,o,l,c,w),y=f.c,m=f.lc;break}}if(t==s.lit)throw new Error("hufDecode issues")}}const S=8-s&7;for(y>>=S,m-=S;m>0;){const e=t[y<<n-m&16383];if(!e.len)throw new Error("hufDecode issues");m-=e.len,g(e.lit,a,y,m,r,o,l,c,w),y=f.c,m=f.lc}}(v,C,e,r,S,b,y,a,{value:0})}function M(e){for(let t=1;t<e.length;t++){const n=e[t-1]+e[t]-128;e[t]=n}}function T(e,t){let n=0,r=Math.floor((e.length+1)/2),o=0;const s=e.length-1;for(;!(o>s||(t[o++]=e[n++],o>s));)t[o++]=e[r++]}function k(e){let t=e.byteLength;const n=new Array;let r=0;const o=new DataView(e);for(;t>0;){const e=o.getInt8(r++);if(e<0){const s=-e;t-=s+1;for(let e=0;e<s;e++)n.push(o.getUint8(r++))}else{const s=e;t-=2;const a=o.getUint8(r++);for(let e=0;e<s+1;e++)n.push(a)}}return n}function E(e,t,n){let r,o=1;for(;o<64;)r=t[e.value],65280==r?o=64:r>>8==255?o+=255&r:(n[o]=r,o++),e.value++}function R(e){const t=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),r=.5*Math.cos(3.14159/8),o=.5*Math.cos(3*3.14159/16),s=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),i=.5*Math.cos(1.374445625),l=new Array(4),c=new Array(4),u=new Array(4),p=new Array(4);for(let d=0;d<8;++d){const h=8*d;l[0]=r*e[h+2],l[1]=a*e[h+2],l[2]=r*e[h+6],l[3]=a*e[h+6],c[0]=n*e[h+1]+o*e[h+3]+s*e[h+5]+i*e[h+7],c[1]=o*e[h+1]-i*e[h+3]-n*e[h+5]-s*e[h+7],c[2]=s*e[h+1]-n*e[h+3]+i*e[h+5]+o*e[h+7],c[3]=i*e[h+1]-s*e[h+3]+o*e[h+5]-n*e[h+7],u[0]=t*(e[h+0]+e[h+4]),u[3]=t*(e[h+0]-e[h+4]),u[1]=l[0]+l[3],u[2]=l[1]-l[2],p[0]=u[0]+u[1],p[1]=u[3]+u[2],p[2]=u[3]-u[2],p[3]=u[0]-u[1],e[h+0]=p[0]+c[0],e[h+1]=p[1]+c[1],e[h+2]=p[2]+c[2],e[h+3]=p[3]+c[3],e[h+4]=p[3]-c[3],e[h+5]=p[2]-c[2],e[h+6]=p[1]-c[1],e[h+7]=p[0]-c[0]}for(let d=0;d<8;++d)l[0]=r*e[16+d],l[1]=a*e[16+d],l[2]=r*e[48+d],l[3]=a*e[48+d],c[0]=n*e[8+d]+o*e[24+d]+s*e[40+d]+i*e[56+d],c[1]=o*e[8+d]-i*e[24+d]-n*e[40+d]-s*e[56+d],c[2]=s*e[8+d]-n*e[24+d]+i*e[40+d]+o*e[56+d],c[3]=i*e[8+d]-s*e[24+d]+o*e[40+d]-n*e[56+d],u[0]=t*(e[d]+e[32+d]),u[3]=t*(e[d]-e[32+d]),u[1]=l[0]+l[3],u[2]=l[1]-l[2],p[0]=u[0]+u[1],p[1]=u[3]+u[2],p[2]=u[3]-u[2],p[3]=u[0]-u[1],e[0+d]=p[0]+c[0],e[8+d]=p[1]+c[1],e[16+d]=p[2]+c[2],e[24+d]=p[3]+c[3],e[32+d]=p[3]-c[3],e[40+d]=p[2]-c[2],e[48+d]=p[1]-c[1],e[56+d]=p[0]-c[0]}function P(e){for(let t=0;t<64;++t){const n=e[0][t],r=e[1][t],o=e[2][t];e[0][t]=n+1.5747*o,e[1][t]=n-.1873*r-.4682*o,e[2][t]=n+1.8556*r}}function x(e,t,n){for(let s=0;s<64;++s)t[n+s]=r.DataUtils.toHalfFloat((o=e[s])<=1?Math.sign(o)*Math.pow(Math.abs(o),2.2):Math.sign(o)*Math.pow(a,Math.abs(o)-1));var o}function A(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function _(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(k(t)),r=new Uint8Array(n.length);return M(n),T(n,r),new DataView(r.buffer)}function L(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=o.a8(t),r=new Uint8Array(n.length);return M(n),T(n,r),new DataView(r.buffer)}function O(e){const n=e.viewer,r={value:e.offset.value},o=new Uint16Array(e.columns*e.lines*(e.inputChannels.length*e.type)),s=new Uint8Array(8192);let a=0;const i=new Array(e.inputChannels.length);for(let t=0,n=e.inputChannels.length;t<n;t++)i[t]={},i[t].start=a,i[t].end=i[t].start,i[t].nx=e.columns,i[t].ny=e.lines,i[t].size=e.type,a+=i[t].nx*i[t].ny*i[t].size;const l=X(n,r),c=X(n,r);if(c>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=c)for(let e=0;e<c-l+1;e++)s[e+l]=z(n,r);const u=new Uint16Array(t),p=function(e,n){let r=0;for(let o=0;o<t;++o)(0==o||e[o>>3]&1<<(7&o))&&(n[r++]=o);const o=r-1;for(;r<t;)n[r++]=0;return o}(s,u),d=N(n,r);C(e.array,n,r,d,o,a);for(let t=0;t<e.inputChannels.length;++t){const e=i[t];for(let n=0;n<i[t].size;++n)v(o,e.start+n,e.nx,e.size,e.ny,e.nx*e.size,p)}!function(e,t,n){for(let r=0;r<n;++r)t[r]=e[t[r]]}(u,o,a);let h=0;const f=new Uint8Array(o.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){const e=i[t],n=e.nx*e.size,r=new Uint8Array(o.buffer,2*e.end,2*n);f.set(r,h),h+=2*n,e.end+=n}return new DataView(f.buffer)}function B(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=o.a8(t),r=e.inputChannels.length*e.lines*e.columns*e.totalBytes,s=new ArrayBuffer(r),a=new DataView(s);let i=0,l=0;const c=new Array(4);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){let r=0;switch(e.inputChannels[t].pixelType){case 1:c[0]=i,c[1]=c[0]+e.columns,i=c[1]+e.columns;for(let t=0;t<e.columns;++t)r+=n[c[0]++]<<8|n[c[1]++],a.setUint16(l,r,!0),l+=2;break;case 2:c[0]=i,c[1]=c[0]+e.columns,c[2]=c[1]+e.columns,i=c[2]+e.columns;for(let t=0;t<e.columns;++t)r+=n[c[0]++]<<24|n[c[1]++]<<16|n[c[2]++]<<8,a.setUint32(l,r,!0),l+=4}}return a}function D(e){const t=e.viewer,n={value:e.offset.value},r=new Uint8Array(e.columns*e.lines*(e.inputChannels.length*e.type*2)),s={version:F(t,n),unknownUncompressedSize:F(t,n),unknownCompressedSize:F(t,n),acCompressedSize:F(t,n),dcCompressedSize:F(t,n),rleCompressedSize:F(t,n),rleUncompressedSize:F(t,n),rleRawSize:F(t,n),totalAcUncompressedCount:F(t,n),totalDcUncompressedCount:F(t,n),acCompression:F(t,n)};if(s.version<2)throw new Error("EXRLoader.parse: "+ee.compression+" version "+s.version+" is unsupported");const a=new Array;let i=X(t,n)-2;for(;i>0;){const e=I(t.buffer,n),r=z(t,n),o=r>>2&3,s=new Int8Array([(r>>4)-1])[0],l=z(t,n);a.push({name:e,index:s,type:l,compression:o}),i-=e.length+3}const l=ee.channels,c=new Array(e.inputChannels.length);for(let t=0;t<e.inputChannels.length;++t){const n=c[t]={},r=l[t];n.name=r.name,n.compression=0,n.decoded=!1,n.type=r.pixelType,n.pLinear=r.pLinear,n.width=e.columns,n.height=e.lines}const u={idx:new Array(3)};for(let t=0;t<e.inputChannels.length;++t){const e=c[t];for(let n=0;n<a.length;++n){const r=a[n];e.name==r.name&&(e.compression=r.compression,r.index>=0&&(u.idx[r.index]=t),e.offset=t)}}let p,d,h;if(s.acCompressedSize>0)switch(s.acCompression){case 0:p=new Uint16Array(s.totalAcUncompressedCount),C(e.array,t,n,s.acCompressedSize,p,s.totalAcUncompressedCount);break;case 1:const r=e.array.slice(n.value,n.value+s.totalAcUncompressedCount),a=o.a8(r);p=new Uint16Array(a.buffer),n.value+=s.totalAcUncompressedCount}if(s.dcCompressedSize>0){const t={array:e.array,offset:n,size:s.dcCompressedSize};d=new Uint16Array(L(t).buffer),n.value+=s.dcCompressedSize}if(s.rleRawSize>0){const t=e.array.slice(n.value,n.value+s.rleCompressedSize);h=k(o.a8(t).buffer),n.value+=s.rleCompressedSize}let f=0;const g=new Array(c.length);for(let e=0;e<g.length;++e)g[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<c.length;++t)g[t].push(f),f+=c[t].width*e.type*2;!function(e,t,n,r,o,s){let a=new DataView(s.buffer);const i=n[e.idx[0]].width,l=n[e.idx[0]].height,c=Math.floor(i/8),u=Math.ceil(i/8),p=Math.ceil(l/8),d=i-8*(u-1),h=l-8*(p-1),f={value:0},g=new Array(3),y=new Array(3),m=new Array(3),w=new Array(3),b=new Array(3);for(let n=0;n<3;++n)b[n]=t[e.idx[n]],g[n]=n<1?0:g[n-1]+u*p,y[n]=new Float32Array(64),m[n]=new Uint16Array(64),w[n]=new Uint16Array(64*u);for(let t=0;t<p;++t){let s=8;t==p-1&&(s=h);let i=8;for(let e=0;e<u;++e){e==u-1&&(i=d);for(let e=0;e<3;++e)m[e].fill(0),m[e][0]=o[g[e]++],E(f,r,m[e]),S=m[e],(v=y[e])[0]=V(S[0]),v[1]=V(S[1]),v[2]=V(S[5]),v[3]=V(S[6]),v[4]=V(S[14]),v[5]=V(S[15]),v[6]=V(S[27]),v[7]=V(S[28]),v[8]=V(S[2]),v[9]=V(S[4]),v[10]=V(S[7]),v[11]=V(S[13]),v[12]=V(S[16]),v[13]=V(S[26]),v[14]=V(S[29]),v[15]=V(S[42]),v[16]=V(S[3]),v[17]=V(S[8]),v[18]=V(S[12]),v[19]=V(S[17]),v[20]=V(S[25]),v[21]=V(S[30]),v[22]=V(S[41]),v[23]=V(S[43]),v[24]=V(S[9]),v[25]=V(S[11]),v[26]=V(S[18]),v[27]=V(S[24]),v[28]=V(S[31]),v[29]=V(S[40]),v[30]=V(S[44]),v[31]=V(S[53]),v[32]=V(S[10]),v[33]=V(S[19]),v[34]=V(S[23]),v[35]=V(S[32]),v[36]=V(S[39]),v[37]=V(S[45]),v[38]=V(S[52]),v[39]=V(S[54]),v[40]=V(S[20]),v[41]=V(S[22]),v[42]=V(S[33]),v[43]=V(S[38]),v[44]=V(S[46]),v[45]=V(S[51]),v[46]=V(S[55]),v[47]=V(S[60]),v[48]=V(S[21]),v[49]=V(S[34]),v[50]=V(S[37]),v[51]=V(S[47]),v[52]=V(S[50]),v[53]=V(S[56]),v[54]=V(S[59]),v[55]=V(S[61]),v[56]=V(S[35]),v[57]=V(S[36]),v[58]=V(S[48]),v[59]=V(S[49]),v[60]=V(S[57]),v[61]=V(S[58]),v[62]=V(S[62]),v[63]=V(S[63]),R(y[e]);P(y);for(let t=0;t<3;++t)x(y[t],w[t],64*e)}let l=0;for(let r=0;r<3;++r){const o=n[e.idx[r]].type;for(let e=8*t;e<8*t+s;++e){l=b[r][e];for(let t=0;t<c;++t){const n=64*t+8*(7&e);a.setUint16(l+0*o,w[r][n+0],!0),a.setUint16(l+2*o,w[r][n+1],!0),a.setUint16(l+4*o,w[r][n+2],!0),a.setUint16(l+6*o,w[r][n+3],!0),a.setUint16(l+8*o,w[r][n+4],!0),a.setUint16(l+10*o,w[r][n+5],!0),a.setUint16(l+12*o,w[r][n+6],!0),a.setUint16(l+14*o,w[r][n+7],!0),l+=16*o}}if(c!=u)for(let e=8*t;e<8*t+s;++e){const t=b[r][e]+8*c*2*o,n=64*c+8*(7&e);for(let e=0;e<i;++e)a.setUint16(t+2*e*o,w[r][n+e],!0)}}}var S,v;const C=new Uint16Array(i);a=new DataView(s.buffer);for(let t=0;t<3;++t){n[e.idx[t]].decoded=!0;const r=n[e.idx[t]].type;if(2==n[t].type)for(let e=0;e<l;++e){const n=b[t][e];for(let e=0;e<i;++e)C[e]=a.getUint16(n+2*e*r,!0);for(let e=0;e<i;++e)a.setFloat32(n+2*e*r,V(C[e]),!0)}}}(u,g,c,p,d,r);for(let t=0;t<c.length;++t){const n=c[t];if(!n.decoded){if(2!==n.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let o=0,s=0;for(let a=0;a<e.lines;++a){let e=g[t][o];for(let t=0;t<n.width;++t){for(let t=0;t<2*n.type;++t)r[e++]=h[s+t*n.width*n.height];s++}o++}}}}return new DataView(r.buffer)}function I(e,t){const n=new Uint8Array(e);let r=0;for(;0!=n[t.value+r];)r+=1;const o=(new TextDecoder).decode(n.slice(t.value,t.value+r));return t.value=t.value+r+1,o}function U(e,t){const n=e.getInt32(t.value,!0);return t.value=t.value+4,n}function N(e,t){const n=e.getUint32(t.value,!0);return t.value=t.value+4,n}function j(e,t){const n=e[t.value];return t.value=t.value+1,n}function z(e,t){const n=e.getUint8(t.value);return t.value=t.value+1,n}const F=function(e,t){let n;return n="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,n};function H(e,t){const n=e.getFloat32(t.value,!0);return t.value+=4,n}function W(e,t){return r.DataUtils.toHalfFloat(H(e,t))}function V(e){const t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)}function X(e,t){const n=e.getUint16(t.value,!0);return t.value+=2,n}function G(e,t){return V(X(e,t))}function $(e,t,n,r,o){return"string"===r||"stringvector"===r||"iccProfile"===r?function(e,t,n){const r=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+n));return t.value=t.value+n,r}(t,n,o):"chlist"===r?function(e,t,n,r){const o=n.value,s=[];for(;n.value<o+r-1;){const r=I(t,n),o=U(e,n),a=z(e,n);n.value+=3;const i=U(e,n),l=U(e,n);s.push({name:r,pixelType:o,pLinear:a,xSampling:i,ySampling:l})}return n.value+=1,s}(e,t,n,o):"chromaticities"===r?function(e,t){return{redX:H(e,t),redY:H(e,t),greenX:H(e,t),greenY:H(e,t),blueX:H(e,t),blueY:H(e,t),whiteX:H(e,t),whiteY:H(e,t)}}(e,n):"compression"===r?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][z(e,t)]}(e,n):"box2i"===r?function(e,t){return{xMin:U(e,t),yMin:U(e,t),xMax:U(e,t),yMax:U(e,t)}}(e,n):"envmap"===r?function(e,t){return["ENVMAP_LATLONG","ENVMAP_CUBE"][z(e,t)]}(e,n):"tiledesc"===r?function(e,t){const n=N(e,t),r=N(e,t),o=z(e,t);return{xSize:n,ySize:r,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&o],roundingMode:["ROUND_DOWN","ROUND_UP"][o>>4]}}(e,n):"lineOrder"===r?function(e,t){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][z(e,t)]}(e,n):"float"===r?H(e,n):"v2f"===r?function(e,t){return[H(e,t),H(e,t)]}(e,n):"v3f"===r?function(e,t){return[H(e,t),H(e,t),H(e,t)]}(e,n):"int"===r?U(e,n):"rational"===r?function(e,t){return[U(e,t),N(e,t)]}(e,n):"timecode"===r?function(e,t){return[N(e,t),N(e,t)]}(e,n):"preview"===r?(n.value+=o,"skipped"):void(n.value+=o)}function Y(e,t,n,r){const o=new Array(e);for(let s=0;s<e;s++){const e=1<<s;let a=t/e|0;"ROUND_UP"==r&&a*e<t&&(a+=1);const i=Math.max(a,1);o[s]=(i+n-1)/n|0}return o}function Z(){const e=this,t=e.offset,n={value:0};for(let r=0;r<e.tileCount;r++){const r=U(e.viewer,t),o=U(e.viewer,t);t.value+=8,e.size=N(e.viewer,t);const s=r*e.blockWidth,a=o*e.blockHeight;e.columns=s+e.blockWidth>e.width?e.width-s:e.blockWidth,e.lines=a+e.blockHeight>e.height?e.height-a:e.blockHeight;const i=e.columns*e.totalBytes,l=e.size<e.lines*i?e.uncompress(e):A(e);t.value+=e.size;for(let t=0;t<e.lines;t++){const r=t*e.columns*e.totalBytes;for(let o=0;o<e.inputChannels.length;o++){const i=ee.channels[o].name,c=e.channelByteOffsets[i]*e.columns,u=e.decodeChannels[i];if(void 0===u)continue;n.value=r+c;const p=(e.height-(1+a+t))*e.outLineWidth;for(let t=0;t<e.columns;t++){const r=p+(t+s)*e.outputChannels+u;e.byteArray[r]=e.getter(l,n)}}}}}function J(){const e=this,t=e.offset,n={value:0};for(let r=0;r<e.height/e.blockHeight;r++){const o=U(e.viewer,t)-ee.dataWindow.yMin;e.size=N(e.viewer,t),e.lines=o+e.blockHeight>e.height?e.height-o:e.blockHeight;const s=e.columns*e.totalBytes,a=e.size<e.lines*s?e.uncompress(e):A(e);t.value+=e.size;for(let t=0;t<e.blockHeight;t++){const o=r*e.blockHeight,i=t+e.scanOrder(o);if(i>=e.height)continue;const l=t*s,c=(e.height-1-i)*e.outLineWidth;for(let t=0;t<e.inputChannels.length;t++){const r=ee.channels[t].name,o=e.channelByteOffsets[r]*e.columns,s=e.decodeChannels[r];if(void 0!==s){n.value=l+o;for(let t=0;t<e.columns;t++){const r=c+t*e.outputChannels+s;e.byteArray[r]=e.getter(a,n)}}}}}}const q={value:0},K=new DataView(e),Q=new Uint8Array(e),ee=function(e,t,n){const r={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");r.version=e.getUint8(4);const o=e.getUint8(5);r.spec={singleTile:!!(2&o),longName:!!(4&o),deepFormat:!!(8&o),multiPart:!!(16&o)},n.value=8;let s=!0;for(;s;){const o=I(t,n);if(0==o)s=!1;else{const s=I(t,n),a=$(e,t,n,s,N(e,n));void 0===a?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${s}'.`):r[o]=a}}if(-7&o)throw console.error("THREE.EXRHeader:",r),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return r}(K,e,q),te=function(e,t,n,o,s){const a={size:0,viewer:t,array:n,offset:o,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,inputChannels:e.channels,channelByteOffsets:{},scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:r.LinearSRGBColorSpace};switch(e.compression){case"NO_COMPRESSION":a.blockHeight=1,a.uncompress=A;break;case"RLE_COMPRESSION":a.blockHeight=1,a.uncompress=_;break;case"ZIPS_COMPRESSION":a.blockHeight=1,a.uncompress=L;break;case"ZIP_COMPRESSION":a.blockHeight=16,a.uncompress=L;break;case"PIZ_COMPRESSION":a.blockHeight=32,a.uncompress=O;break;case"PXR24_COMPRESSION":a.blockHeight=16,a.uncompress=B;break;case"DWAA_COMPRESSION":a.blockHeight=32,a.uncompress=D;break;case"DWAB_COMPRESSION":a.blockHeight=256,a.uncompress=D;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}const i={};for(const t of e.channels)switch(t.name){case"Y":case"R":case"G":case"B":case"A":i[t.name]=!0,a.type=t.pixelType}let l=!1;if(i.R&&i.G&&i.B)l=!i.A,a.outputChannels=4,a.decodeChannels={R:0,G:1,B:2,A:3};else{if(!i.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");a.outputChannels=1,a.decodeChannels={Y:0}}if(1==a.type)switch(s){case r.FloatType:a.getter=G;break;case r.HalfFloatType:a.getter=X}else{if(2!=a.type)throw new Error("EXRLoader.parse: unsupported pixelType "+a.type+" for "+e.compression+".");switch(s){case r.FloatType:a.getter=H;break;case r.HalfFloatType:a.getter=W}}a.columns=a.width;const c=a.width*a.height*a.outputChannels;switch(s){case r.FloatType:a.byteArray=new Float32Array(c),l&&a.byteArray.fill(1,0,c);break;case r.HalfFloatType:a.byteArray=new Uint16Array(c),l&&a.byteArray.fill(15360,0,c);break;default:console.error("THREE.EXRLoader: unsupported type: ",s)}let u=0;for(const t of e.channels)void 0!==a.decodeChannels[t.name]&&(a.channelByteOffsets[t.name]=u),u+=2*t.pixelType;if(a.totalBytes=u,a.outLineWidth=a.width*a.outputChannels,"INCREASING_Y"===e.lineOrder?a.scanOrder=e=>e:a.scanOrder=e=>a.height-1-e,4==a.outputChannels?(a.format=r.RGBAFormat,a.colorSpace=r.LinearSRGBColorSpace):(a.format=r.RedFormat,a.colorSpace=r.NoColorSpace),e.spec.singleTile){a.blockHeight=e.tiles.ySize,a.blockWidth=e.tiles.xSize;const n=function(e,t,n){let r=0;switch(e.levelMode){case"ONE_LEVEL":r=1;break;case"MIPMAP_LEVELS":r=function(e,t){const n=Math.log2(e);return"ROUND_DOWN"==t?Math.floor(n):Math.ceil(n)}(Math.max(t,n),e.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return r}(e.tiles,a.width,a.height),r=Y(n,a.width,e.tiles.xSize,e.tiles.roundingMode),s=Y(n,a.height,e.tiles.ySize,e.tiles.roundingMode);a.tileCount=r[0]*s[0];for(let e=0;e<n;e++)for(let n=0;n<s[e];n++)for(let n=0;n<r[e];n++)F(t,o);a.decode=Z.bind(a)}else{a.blockWidth=a.width;const e=Math.ceil(a.height/a.blockHeight);for(let n=0;n<e;n++)F(t,o);a.decode=J.bind(a)}return a}(ee,K,Q,q,this.type);return te.decode(),{header:ee,width:te.width,height:te.height,data:te.byteArray,format:te.format,colorSpace:te.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,n,o){return super.load(e,(function(e,n){e.colorSpace=n.colorSpace,e.minFilter=r.LinearFilter,e.magFilter=r.LinearFilter,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,n)}),n,o)}}const a=new WeakMap;class i extends r.Loader{constructor(e){super(e),this.libraryPath="",this.libraryPending=null,this.libraryBinary=null,this.libraryConfig={},this.url="",this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig={},this.materials=[],this.warnings=[]}setLibraryPath(e){return this.libraryPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,o){const s=new r.FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),this.url=e,s.load(e,(n=>{if(a.has(n))return a.get(n).promise.then(t).catch(o);this.decodeObjects(n,e).then((e=>{e.userData.warnings=this.warnings,t(e)})).catch((e=>o(e)))}),n,o)}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}decodeObjects(e,t){let n,r;const o=e.byteLength,s=this._getWorker(o).then((t=>(n=t,r=this.workerNextTaskID++,new Promise(((t,o)=>{n._callbacks[r]={resolve:t,reject:o},n.postMessage({type:"decode",id:r,buffer:e},[e])}))))).then((e=>this._createGeometry(e.data))).catch((e=>{throw e}));return s.catch((()=>!0)).then((()=>{n&&r&&this._releaseTask(n,r)})),a.set(e,{url:t,promise:s}),s}parse(e,t,n){this.decodeObjects(e,"").then((e=>{e.userData.warnings=this.warnings,t(e)})).catch((e=>n(e)))}_compareMaterials(e){const t={};t.name=e.name,t.color={},t.color.r=e.color.r,t.color.g=e.color.g,t.color.b=e.color.b,t.type=e.type,t.vertexColors=e.vertexColors;const n=JSON.stringify(t);for(let e=0;e<this.materials.length;e++){const t=this.materials[e],r={};if(r.name=t.name,r.color={},r.color.r=t.color.r,r.color.g=t.color.g,r.color.b=t.color.b,r.type=t.type,r.vertexColors=t.vertexColors,JSON.stringify(r)===n)return t}return this.materials.push(e),e}_createMaterial(e,t){if(void 0===e)return new r.MeshStandardMaterial({color:new r.Color(1,1,1),metalness:.8,name:r.Loader.DEFAULT_MATERIAL_NAME,side:r.DoubleSide});const n=new r.MeshPhysicalMaterial({color:new r.Color(e.diffuseColor.r/255,e.diffuseColor.g/255,e.diffuseColor.b/255),emissive:new r.Color(e.emissionColor.r,e.emissionColor.g,e.emissionColor.b),flatShading:e.disableLighting,ior:e.indexOfRefraction,name:e.name,reflectivity:e.reflectivity,opacity:1-e.transparency,side:r.DoubleSide,specularColor:e.specularColor,transparent:e.transparency>0});if(n.userData.id=e.id,e.pbrSupported){const t=e.pbr;n.anisotropy=t.anisotropic,n.anisotropyRotation=t.anisotropicRotation,n.color=new r.Color(t.baseColor.r,t.baseColor.g,t.baseColor.b),n.clearcoat=t.clearcoat,n.clearcoatRoughness=t.clearcoatRoughness,n.metalness=t.metallic,n.transmission=1-t.opacity,n.roughness=t.roughness,n.sheen=t.sheen,n.specularIntensity=t.specular,n.thickness=t.subsurface}e.pbrSupported&&0===e.pbr.opacity&&1===e.transparency&&(n.opacity=.2,n.transmission=1);const o=new r.TextureLoader;for(let t=0;t<e.textures.length;t++){const s=e.textures[t];if(null!==s.image){const e=o.load(s.image);switch(s.type){case"Bump":n.bumpMap=e;break;case"Diffuse":case"PBR_BaseColor":n.map=e;break;case"Emap":n.envMap=e;break;case"Opacity":n.transmissionMap=e;break;case"Transparency":case"PBR_Alpha":n.alphaMap=e,n.transparent=!0;break;case"PBR_AmbientOcclusion":n.aoMap=e;break;case"PBR_Anisotropic":n.anisotropyMap=e;break;case"PBR_Clearcoat":n.clearcoatMap=e;break;case"PBR_ClearcoatBump":n.clearcoatNormalMap=e;break;case"PBR_ClearcoatRoughness":n.clearcoatRoughnessMap=e;break;case"PBR_Displacement":n.displacementMap=e;break;case"PBR_Emission":n.emissiveMap=e;break;case"PBR_Metallic":n.metalnessMap=e;break;case"PBR_Roughness":n.roughnessMap=e;break;case"PBR_Sheen":n.sheenColorMap=e;break;case"PBR_Specular":n.specularColorMap=e;break;case"PBR_Subsurface":n.thicknessMap=e;break;default:this.warnings.push({message:`THREE.3DMLoader: No conversion exists for 3dm ${s.type}.`,type:"no conversion"})}e.wrapS=0===s.wrapU?r.RepeatWrapping:r.ClampToEdgeWrapping,e.wrapT=0===s.wrapV?r.RepeatWrapping:r.ClampToEdgeWrapping,s.repeat&&e.repeat.set(s.repeat[0],s.repeat[1])}}return t&&(new s).load(t.image,(function(e){e.mapping=THREE.EquirectangularReflectionMapping,n.envMap=e})),n}_createGeometry(e){const t=new r.Object3D,n=[],o=[],s=[];t.userData.layers=e.layers,t.userData.groups=e.groups,t.userData.settings=e.settings,t.userData.settings.renderSettings=e.renderSettings,t.userData.objectType="File3dm",t.userData.materials=null,t.name=this.url;let a=e.objects;const i=e.materials;for(let r=0;r<a.length;r++){const l=a[r],c=l.attributes;switch(l.objectType){case"InstanceDefinition":o.push(l);break;case"InstanceReference":s.push(l);break;default:let r=null;switch(c.materialSource.name){case"ObjectMaterialSource_MaterialFromLayer":c.layerIndex>=0&&(r=e.layers[c.layerIndex].renderMaterialIndex);break;case"ObjectMaterialSource_MaterialFromObject":c.materialIndex>=0&&(r=c.materialIndex)}let a=null;if(r>=0){const t=i[r];a=this._createMaterial(t,e.renderEnvironment)}const u=this._createObject(l,a);if(void 0===u)continue;const p=e.layers[c.layerIndex];u.visible=!p||e.layers[c.layerIndex].visible,c.isInstanceDefinitionObject?n.push(u):t.add(u)}}for(let e=0;e<o.length;e++){const i=o[e];a=[];for(let e=0;e<i.attributes.objectIds.length;e++){const t=i.attributes.objectIds[e];for(let e=0;e<n.length;e++)t===n[e].userData.attributes.id&&a.push(n[e])}for(let e=0;e<s.length;e++){const n=s[e];if(n.geometry.parentIdefId===i.attributes.id){const e=new r.Object3D,o=n.geometry.xform.array,s=new r.Matrix4;s.set(...o),e.applyMatrix4(s);for(let t=0;t<a.length;t++)e.add(a[t].clone(!0));t.add(e)}}}return t.userData.materials=this.materials,t.name="",t}_createObject(e,t){const n=new r.BufferGeometryLoader,o=e.attributes;let s,a,i,l;switch(e.objectType){case"Point":case"PointSet":s=n.parse(e.geometry),s.attributes.hasOwnProperty("color")?a=new r.PointsMaterial({vertexColors:!0,sizeAttenuation:!1,size:2}):(i=o.drawColor,l=new r.Color(i.r/255,i.g/255,i.b/255),a=new r.PointsMaterial({color:l,sizeAttenuation:!1,size:2})),a=this._compareMaterials(a);const c=new r.Points(s,a);return c.userData.attributes=o,c.userData.objectType=e.objectType,o.name&&(c.name=o.name),c;case"Mesh":case"Extrusion":case"SubD":case"Brep":if(null===e.geometry)return;s=n.parse(e.geometry),null===t&&(t=this._createMaterial()),s.attributes.hasOwnProperty("color")&&(t.vertexColors=!0),t=this._compareMaterials(t);const u=new r.Mesh(s,t);return u.castShadow=o.castsShadows,u.receiveShadow=o.receivesShadows,u.userData.attributes=o,u.userData.objectType=e.objectType,o.name&&(u.name=o.name),u;case"Curve":s=n.parse(e.geometry),i=o.drawColor,l=new r.Color(i.r/255,i.g/255,i.b/255),a=new r.LineBasicMaterial({color:l}),a=this._compareMaterials(a);const p=new r.Line(s,a);return p.userData.attributes=o,p.userData.objectType=e.objectType,o.name&&(p.name=o.name),p;case"TextDot":s=e.geometry;const d=document.createElement("canvas").getContext("2d"),h=`${s.fontHeight}px ${s.fontFace}`;d.font=h;const f=d.measureText(s.text).width+10,g=s.fontHeight+10,y=window.devicePixelRatio;d.canvas.width=f*y,d.canvas.height=g*y,d.canvas.style.width=f+"px",d.canvas.style.height=g+"px",d.setTransform(y,0,0,y,0,0),d.font=h,d.textBaseline="middle",d.textAlign="center",l=o.drawColor,d.fillStyle=`rgba(${l.r},${l.g},${l.b},${l.a})`,d.fillRect(0,0,f,g),d.fillStyle="white",d.fillText(s.text,f/2,g/2);const m=new r.CanvasTexture(d.canvas);m.minFilter=r.LinearFilter,m.wrapS=r.ClampToEdgeWrapping,m.wrapT=r.ClampToEdgeWrapping,a=new r.SpriteMaterial({map:m,depthTest:!1});const w=new r.Sprite(a);return w.position.set(s.point[0],s.point[1],s.point[2]),w.scale.set(f/10,g/10,1),w.userData.attributes=o,w.userData.objectType=e.objectType,o.name&&(w.name=o.name),w;case"Light":let b;switch(s=e.geometry,s.lightStyle.name){case"LightStyle_WorldPoint":b=new r.PointLight,b.castShadow=o.castsShadows,b.position.set(s.location[0],s.location[1],s.location[2]),b.shadow.normalBias=.1;break;case"LightStyle_WorldSpot":b=new r.SpotLight,b.castShadow=o.castsShadows,b.position.set(s.location[0],s.location[1],s.location[2]),b.target.position.set(s.direction[0],s.direction[1],s.direction[2]),b.angle=s.spotAngleRadians,b.shadow.normalBias=.1;break;case"LightStyle_WorldRectangular":b=new r.RectAreaLight;const e=Math.abs(s.width[2]),t=Math.abs(s.length[0]);b.position.set(s.location[0]-t/2,s.location[1],s.location[2]-e/2),b.height=t,b.width=e,b.lookAt(s.direction[0],s.direction[1],s.direction[2]);break;case"LightStyle_WorldDirectional":b=new r.DirectionalLight,b.castShadow=o.castsShadows,b.position.set(s.location[0],s.location[1],s.location[2]),b.target.position.set(s.direction[0],s.direction[1],s.direction[2]),b.shadow.normalBias=.1}return b&&(b.intensity=s.intensity,i=s.diffuse,l=new r.Color(i.r/255,i.g/255,i.b/255),b.color=l,b.userData.attributes=o,b.userData.objectType=e.objectType),b}}_initLibrary(){if(!this.libraryPending){const e=new r.FileLoader(this.manager);e.setPath(this.libraryPath);const t=new Promise(((t,n)=>{e.load("rhino3dm.js",t,void 0,n)})),n=new r.FileLoader(this.manager);n.setPath(this.libraryPath),n.setResponseType("arraybuffer");const o=new Promise(((e,t)=>{n.load("rhino3dm.wasm",e,void 0,t)}));this.libraryPending=Promise.all([t,o]).then((([e,t])=>{this.libraryConfig.wasmBinary=t;const n=l.toString(),r=["/* rhino3dm.js */",e,"/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r]))}))}return this.libraryPending}_getWorker(e){return this._initLibrary().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",libraryConfig:this.libraryConfig}),e.onmessage=t=>{const n=t.data;switch(n.type){case"warning":this.warnings.push(n.data),console.warn(n.data);break;case"decode":e._callbacks[n.id].resolve(n);break;case"error":e._callbacks[n.id].reject(n);break;default:console.error('THREE.Rhino3dmLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function l(){let e,t,n,r;function o(e,t,n){const r=[];for(let o=0;o<t.length;o++){const a=e.getTexture(t[o]);if(a){let e=t[o].constructor.name;e=e.substring(12,e.length);const i=s(a,e,n);r.push(i),a.delete()}}return r}function s(e,t,n){const o={type:t},s=n.getEmbeddedFileAsBase64(e.fileName);o.wrapU=e.wrapU,o.wrapV=e.wrapV,o.wrapW=e.wrapW;const a=e.uvwTransform.toFloatArray(!0);return o.repeat=[a[0],a[5]],s?o.image="data:image/png;base64,"+s:(self.postMessage({type:"warning",id:r,data:{message:`THREE.3DMLoader: Image for ${t} texture not embedded in file.`,type:"missing resource"}}),o.image=null),o}function a(e,t){const o=e.geometry(),s=e.attributes();let a,c,u,p,d,h=o.objectType;switch(h){case n.ObjectType.Curve:const e=l(o,100);u={},c={},p={},u.itemSize=3,u.type="Float32Array",u.array=[];for(let t=0;t<e.length;t++)u.array.push(e[t][0]),u.array.push(e[t][1]),u.array.push(e[t][2]);c.position=u,p.attributes=c,a={data:p};break;case n.ObjectType.Point:const f=o.location;u={};const g={};c={},p={},u.itemSize=3,u.type="Float32Array",u.array=[f[0],f[1],f[2]];const y=s.drawColor(t);g.itemSize=3,g.type="Float32Array",g.array=[y.r/255,y.g/255,y.b/255],c.position=u,c.color=g,p.attributes=c,a={data:p};break;case n.ObjectType.PointSet:case n.ObjectType.Mesh:a=o.toThreejsJSON();break;case n.ObjectType.Brep:const m=o.faces();d=new n.Mesh;for(let e=0;e<m.count;e++){const t=m.get(e),r=t.getMesh(n.MeshType.Any);r&&(d.append(r),r.delete()),t.delete()}d.faces().count>0&&(d.compact(),a=d.toThreejsJSON(),m.delete()),d.delete();break;case n.ObjectType.Extrusion:d=o.getMesh(n.MeshType.Any),d&&(a=d.toThreejsJSON(),d.delete());break;case n.ObjectType.TextDot:a=i(o);break;case n.ObjectType.Light:a=i(o),"LightStyle_WorldLinear"===a.lightStyle.name&&self.postMessage({type:"warning",id:r,data:{message:`THREE.3DMLoader: No conversion exists for ${h.constructor.name} ${a.lightStyle.name}`,type:"no conversion",guid:s.id}});break;case n.ObjectType.InstanceReference:a=i(o),a.xform=i(o.xform),a.xform.array=o.xform.toFloatArray(!0);break;case n.ObjectType.SubD:o.subdivide(3),d=n.Mesh.createFromSubDControlNet(o,!1),d&&(a=d.toThreejsJSON(),d.delete());break;default:self.postMessage({type:"warning",id:r,data:{message:`THREE.3DMLoader: Conversion not implemented for ${h.constructor.name}`,type:"not implemented",guid:s.id}})}if(a)return c=i(s),c.geometry=i(o),s.groupCount>0&&(c.groupIds=s.getGroupList()),s.userStringCount>0&&(c.userStrings=s.getUserStrings()),o.userStringCount>0&&(c.geometry.userStrings=o.getUserStrings()),s.decals().count>0&&self.postMessage({type:"warning",id:r,data:{message:"THREE.3DMLoader: No conversion exists for the decals associated with this object.",type:"no conversion",guid:s.id}}),c.drawColor=s.drawColor(t),h=h.constructor.name,h=h.substring(11,h.length),{geometry:a,attributes:c,objectType:h};self.postMessage({type:"warning",id:r,data:{message:`THREE.3DMLoader: ${h.constructor.name} has no associated mesh geometry.`,type:"missing mesh",guid:s.id}})}function i(e){const t={};for(const n in e){const r=e[n];"function"!=typeof r&&("object"==typeof r&&null!==r&&r.hasOwnProperty("constructor")?t[n]={name:r.constructor.name,value:r.value}:t[n]="object"==typeof r&&null!==r?i(r):r)}return t}function l(e,t){let r=t,o=[];const s=[];if(e instanceof n.LineCurve)return[e.pointAtStart,e.pointAtEnd];if(e instanceof n.PolylineCurve){r=e.pointCount;for(let t=0;t<r;t++)o.push(e.point(t));return o}if(e instanceof n.PolyCurve){const t=e.segmentCount;for(let n=0;n<t;n++){const t=e.segmentCurve(n),s=l(t,r);o=o.concat(s),t.delete()}return o}if(e instanceof n.ArcCurve&&(r=Math.floor(e.angleDegrees/5),r=r<2?2:r),e instanceof n.NurbsCurve&&1===e.degree){const t=e.tryGetPolyline();for(let e=0;e<t.count;e++)o.push(t.get(e));return t.delete(),o}const a=e.domain,i=r-1;for(let t=0;t<r;t++){const n=a[0]+t/i*(a[1]-a[0]);if(n===a[0]||n===a[1]){s.push(n);continue}const r=e.tangentAt(n),o=e.tangentAt(s.slice(-1)[0]),l=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],c=o[0]*o[0]+o[1]*o[1]+o[2]*o[2],u=Math.sqrt(l*c);let p;if(0===u)p=Math.PI/2;else{const e=(r.x*o.x+r.y*o.y+r.z*o.z)/u;p=Math.acos(Math.max(-1,Math.min(1,e)))}p<.1||s.push(n)}return o=s.map((t=>e.pointAt(t))),o}onmessage=function(s){const l=s.data;switch(l.type){case"init":t=l.libraryConfig;const s=t.wasmBinary;let c;e=new Promise((function(e){c={wasmBinary:s,onRuntimeInitialized:e},rhino3dm(c)})).then((()=>{n=c}));break;case"decode":r=l.id;const u=l.buffer;e.then((()=>{try{const e=function(e,t){const n=new Uint8Array(t),r=e.File3dm.fromByteArray(n),s=[],l=[],c=[],u=[],p=[],d=[],h=[],f=r.objects(),g=f.count;for(let e=0;e<g;e++){const t=f.get(e),n=a(t,r);t.delete(),n&&s.push(n)}for(let e=0;e<r.instanceDefinitions().count;e++){const t=r.instanceDefinitions().get(e),n=i(t);n.objectIds=t.getObjectIds(),s.push({geometry:null,attributes:n,objectType:"InstanceDefinition"})}const y=[e.TextureType.Diffuse,e.TextureType.Bump,e.TextureType.Transparency,e.TextureType.Opacity,e.TextureType.Emap],m=[e.TextureType.PBR_BaseColor,e.TextureType.PBR_Subsurface,e.TextureType.PBR_SubsurfaceScattering,e.TextureType.PBR_SubsurfaceScatteringRadius,e.TextureType.PBR_Metallic,e.TextureType.PBR_Specular,e.TextureType.PBR_SpecularTint,e.TextureType.PBR_Roughness,e.TextureType.PBR_Anisotropic,e.TextureType.PBR_Anisotropic_Rotation,e.TextureType.PBR_Sheen,e.TextureType.PBR_SheenTint,e.TextureType.PBR_Clearcoat,e.TextureType.PBR_ClearcoatBump,e.TextureType.PBR_ClearcoatRoughness,e.TextureType.PBR_OpacityIor,e.TextureType.PBR_OpacityRoughness,e.TextureType.PBR_Emission,e.TextureType.PBR_AmbientOcclusion,e.TextureType.PBR_Displacement];for(let e=0;e<r.materials().count;e++){const t=r.materials().get(e),n=i(t),s=[];s.push(...o(t,y,r)),n.pbrSupported=t.physicallyBased().supported,n.pbrSupported&&(s.push(...o(t,m,r)),n.pbr=i(t.physicallyBased())),n.textures=s,l.push(n),t.delete()}for(let e=0;e<r.layers().count;e++){const t=r.layers().get(e),n=i(t);c.push(n),t.delete()}for(let e=0;e<r.views().count;e++){const t=r.views().get(e),n=i(t);u.push(n),t.delete()}for(let e=0;e<r.namedViews().count;e++){const t=r.namedViews().get(e),n=i(t);p.push(n),t.delete()}for(let e=0;e<r.groups().count;e++){const t=r.groups().get(e),n=i(t);d.push(n),t.delete()}const w=i(r.settings()),b=r.strings().count;for(let e=0;e<b;e++)h.push(r.strings().get(e));const S=r.settings().renderSettings().renderEnvironments.reflectionId,v=r.renderContent();let C=null;for(let e=0;e<v.count;e++){const t=v.get(e);switch(t.kind){case"environment":if(t.id!==S)break;const e=t.findChild("texture").fileName;for(let t=0;t<r.embeddedFiles().count;t++)e===r.embeddedFiles().get(t).fileName&&(C={type:"renderEnvironment",image:"data:image/png;base64,"+r.getEmbeddedFileAsBase64(e),name:e})}}const M={ambientLight:r.settings().renderSettings().ambientLight,backgroundColorTop:r.settings().renderSettings().backgroundColorTop,backgroundColorBottom:r.settings().renderSettings().backgroundColorBottom,useHiddenLights:r.settings().renderSettings().useHiddenLights,depthCue:r.settings().renderSettings().depthCue,flatShade:r.settings().renderSettings().flatShade,renderBackFaces:r.settings().renderSettings().renderBackFaces,renderPoints:r.settings().renderSettings().renderPoints,renderCurves:r.settings().renderSettings().renderCurves,renderIsoParams:r.settings().renderSettings().renderIsoParams,renderMeshEdges:r.settings().renderSettings().renderMeshEdges,renderAnnotations:r.settings().renderSettings().renderAnnotations,useViewportSize:r.settings().renderSettings().useViewportSize,scaleBackgroundToFit:r.settings().renderSettings().scaleBackgroundToFit,transparentBackground:r.settings().renderSettings().transparentBackground,imageDpi:r.settings().renderSettings().imageDpi,shadowMapLevel:r.settings().renderSettings().shadowMapLevel,namedView:r.settings().renderSettings().namedView,snapShot:r.settings().renderSettings().snapShot,specificViewport:r.settings().renderSettings().specificViewport,groundPlane:i(r.settings().renderSettings().groundPlane),safeFrame:i(r.settings().renderSettings().safeFrame),dithering:i(r.settings().renderSettings().dithering),skylight:i(r.settings().renderSettings().skylight),linearWorkflow:i(r.settings().renderSettings().linearWorkflow),renderChannels:i(r.settings().renderSettings().renderChannels),sun:i(r.settings().renderSettings().sun),renderEnvironments:i(r.settings().renderSettings().renderEnvironments),postEffects:i(r.settings().renderSettings().postEffects)};return r.delete(),{objects:s,materials:l,layers:c,views:u,namedViews:p,groups:d,strings:h,settings:w,renderSettings:M,renderEnvironment:C}}(n,u);self.postMessage({type:"decode",id:l.id,data:e})}catch(e){self.postMessage({type:"error",id:l.id,error:e})}}))}}}}}]);